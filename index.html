<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Professional AI-Powered Text-to-Speech & Audio Transcription">
    <title>Lumen Voice Studio - Professional AI Voice Generation</title>
    
    <!-- Inter Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.js"></script>
    <link type="text/css" rel="stylesheet" href="https://www.gstatic.com/firebasejs/ui/6.1.0/firebase-ui-auth.css" />

    <style>
        :root {
            --primary-blue: #2563eb;
            --primary-green: #10b981;
            --gradient-primary: linear-gradient(135deg, #2563eb 0%, #10b981 100%);
            --gradient-secondary: linear-gradient(135deg, #1e40af 0%, #059669 100%);
            --gradient-accent: linear-gradient(135deg, #3b82f6 0%, #34d399 100%);
            --style-orange: #f97316;
            --style-orange-light: #fb923c;
            --style-orange-dark: #ea580c;
            --bg-primary: #0a0a0f;
            --bg-secondary: #1a1a2e;
            --bg-tertiary: #16213e;
            --bg-card: #1e1e3f;
            --bg-glass: rgba(30, 30, 63, 0.8);
            --text-primary: #e8e8ff;
            --text-secondary: #b8b8d6;
            --text-muted: #8e8eb0;
            --border-subtle: rgba(37, 99, 235, 0.1);
            --border-medium: rgba(37, 99, 235, 0.2);
            --shadow-soft: 0 4px 20px rgba(37, 99, 235, 0.1);
            --shadow-medium: 0 8px 32px rgba(37, 99, 235, 0.2);
            --shadow-strong: 0 20px 50px rgba(37, 99, 235, 0.3);
            --nav-width: 70px;
            --controls-width: 380px;
        }

        [data-theme="light"] {
            --bg-primary: #fafbff;
            --bg-secondary: #f4f5f9;
            --bg-tertiary: #e8eaf6;
            --bg-card: #ffffff;
            --bg-glass: rgba(255, 255, 255, 0.9);
            --text-primary: #1e293b;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --shadow-soft: 0 4px 20px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 8px 32px rgba(0, 0, 0, 0.12);
            --shadow-strong: 0 20px 50px rgba(0, 0, 0, 0.15);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* ==================== AUTH CONTAINER ==================== */
        #auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            background: var(--bg-primary);
            position: relative;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .auth-background {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 1;
            overflow: hidden;
        }

        .auth-blob-1 {
            position: absolute;
            width: 400px;
            height: 400px;
            border-radius: 50%;
            background: var(--primary-blue);
            opacity: 0.1;
            filter: blur(80px);
            top: -100px;
            right: -100px;
            animation: float 20s infinite alternate;
        }

        .auth-blob-2 {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: var(--primary-green);
            opacity: 0.1;
            filter: blur(80px);
            bottom: -50px;
            left: -50px;
            animation: float 15s infinite alternate-reverse;
        }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            50% { transform: translate(20px, -20px) scale(1.1); }
        }

        .auth-card {
            width: 100%;
            max-width: 420px;
            background: var(--bg-card);
            padding: 2.5rem;
            border-radius: 24px;
            box-shadow: var(--shadow-soft);
            border: 1px solid var(--border-subtle);
            position: relative;
            z-index: 2;
            text-align: center;
        }

        .auth-logo {
            font-weight: 800;
            font-size: 1.8rem;
            letter-spacing: -0.03em;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            justify-content: center;
        }
        
        .auth-logo i {
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            font-size: 2rem;
        }
        
        .auth-logo span { 
            background: var(--gradient-primary); 
            -webkit-background-clip: text; 
            color: transparent; 
        }

        .auth-title {
            font-weight: 700;
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
        }

        .auth-subtitle {
            color: var(--text-muted);
            font-size: 0.95rem;
            line-height: 1.5;
            margin-bottom: 2rem;
        }

        /* Firebase UI Customization */
        .firebaseui-container {
            max-width: 100% !important;
        }

        .firebaseui-card-header {
            display: none !important;
        }

        .firebaseui-card-content {
            padding: 0 !important;
        }

        .firebaseui-idp-list {
            margin: 0 !important;
        }

        .firebaseui-idp-button {
            border-radius: 12px !important;
            border: 1px solid var(--border-subtle) !important;
            background: var(--bg-tertiary) !important;
            color: var(--text-primary) !important;
            box-shadow: none !important;
            margin-bottom: 1rem !important;
            transition: all 0.3s ease !important;
            height: auto !important;
            min-height: 48px !important;
            font-family: 'Inter', sans-serif !important;
        }

        .firebaseui-idp-button:hover {
            background: var(--bg-card) !important;
            border-color: var(--primary-blue) !important;
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft) !important;
        }

        .firebaseui-idp-text {
            font-size: 0.95rem !important;
            font-weight: 500 !important;
            font-family: 'Inter', sans-serif !important;
        }

        .auth-footer {
            margin-top: 2rem;
            text-align: center;
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        
        .auth-footer a { 
            color: var(--primary-blue); 
            text-decoration: none; 
            font-weight: 500; 
        }
        
        .auth-footer a:hover { 
            text-decoration: underline; 
        }

        .theme-toggle-auth {
            position: absolute;
            top: 20px;
            right: 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.3s ease;
            z-index: 3;
        }

        .theme-toggle-auth:hover {
            background: var(--bg-card);
            transform: rotate(180deg);
        }

        /* ==================== APP CONTAINER ==================== */
        #app-container {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        /* Navigation Bar */
        .nav-sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: var(--nav-width);
            height: 100vh;
            background: var(--bg-card);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1.5rem 0;
            z-index: 100;
        }

        .nav-logo {
            width: 40px;
            height: 40px;
            background: var(--gradient-primary);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 2rem;
            font-size: 1.25rem;
            color: white;
            font-weight: 800;
        }

        .nav-item {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-bottom: 0.5rem;
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--gradient-primary);
            color: white;
        }

        .nav-item.active::after {
            content: '';
            position: absolute;
            right: -12px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 24px;
            background: var(--gradient-primary);
            border-radius: 2px;
        }

        .nav-spacer {
            flex: 1;
        }

        .nav-user {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--gradient-accent);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .nav-user:hover {
            transform: scale(1.1);
        }

        /* Main Content Area */
        .main-wrapper {
            margin-left: var(--nav-width);
            margin-right: var(--controls-width);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Top Bar */
        .top-bar {
            height: 70px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
        }

        .top-bar h1 {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }

        .top-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .theme-toggle {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-primary);
            transition: all 0.2s ease;
        }

        .theme-toggle:hover {
            background: var(--border-medium);
        }

        /* Status Indicator */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.875rem;
            font-weight: 500;
            margin-left: 1rem;
        }

        .status-indicator.online {
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .status-indicator.offline {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Workspace Area */
        .workspace {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            background: var(--bg-primary);
        }

        .workspace-section {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 1.5rem;
            border: 1px solid var(--border-subtle);
            display: none; /* Hidden by default */
        }

        .workspace-section.active {
            display: block; /* Show active section */
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        /* Text Composition Area */
        .text-input {
            width: 100%;
            min-height: 300px;
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            line-height: 1.6;
            resize: none;
            padding: 0;
        }

        .text-input::placeholder {
            color: var(--text-muted);
        }

        .char-counter {
            font-size: 0.75rem;
            color: var(--text-muted);
            background: var(--bg-card);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            border: 1px solid var(--border-subtle);
            display: inline-block;
            margin-top: 0.5rem;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-weight: 500;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-medium);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
        }

        .btn-secondary:hover {
            background: var(--border-medium);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--primary-green) 0%, #059669 100%);
            color: white;
        }

        .btn-download {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
        }

        .btn-transcribe {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
            color: white;
        }

        /* Audio Player */
        .audio-player {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1.5rem;
        }

        .audio-player audio {
            width: 100%;
        }

        .audio-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        /* Media Import */
        .media-import {
            border: 2px dashed var(--border-subtle);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background: var(--bg-tertiary);
        }

        .media-import:hover {
            border-color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.05);
        }

        .media-import.has-file {
            border-color: var(--primary-green);
            background: rgba(16, 185, 129, 0.05);
        }

        .upload-icon {
            font-size: 2rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .upload-text {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Voice Library Section */
        .voice-library-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .voice-library-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1.5rem;
            text-align: center;
            transition: all 0.2s ease;
        }

        .voice-library-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .voice-library-card.selected {
            border-color: var(--primary-blue);
            background: rgba(37, 99, 235, 0.1);
        }

        /* History Section */
        .history-list {
            margin-top: 1.5rem;
        }

        .history-item {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 0.75rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: var(--border-medium);
        }

        .history-info {
            flex: 1;
        }

        .history-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Settings Section */
        .settings-group {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        /* Profile Section */
        .profile-card {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            margin-top: 1.5rem;
        }

        .profile-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: var(--gradient-primary);
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: white;
            font-weight: 600;
        }

        /* Controls Panel */
        .controls-panel {
            position: fixed;
            right: 0;
            top: 0;
            width: var(--controls-width);
            height: 100vh;
            background: var(--bg-card);
            border-left: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
        }

        .controls-header {
            padding: 1.5rem;
            border-bottom: 1px solid var(--border-subtle);
        }

        .controls-tabs {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-muted);
            transition: all 0.2s ease;
        }

        .tab.active {
            background: var(--gradient-primary);
            color: white;
        }

        .controls-content {
            flex: 1;
            overflow-y: auto;
            padding: 1.5rem;
        }

        .control-group {
            margin-bottom: 1.5rem;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            font-family: 'Inter', sans-serif;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary-blue);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Voice Search and Filters */
        .voice-filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .voice-filters .form-control {
            flex: 1;
        }

        /* Voice Library */
        .voice-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .voice-chip {
            background: var(--bg-tertiary);
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .voice-chip:hover {
            border-color: var(--primary-blue);
            transform: translateY(-2px);
            box-shadow: var(--shadow-soft);
        }

        .voice-chip.selected {
            background: var(--gradient-primary);
            color: white;
            border-color: var(--primary-blue);
        }

        .voice-chip.best::after {
            content: 'ðŸ‘‘';
            position: absolute;
            top: -8px;
            right: -8px;
            background: var(--style-orange);
            color: white;
            font-size: 14px;
            padding: 2px 6px;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-name {
            font-weight: 700;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
        }

        .voice-gender {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Recommended Voices */
        .voice-recommendations {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.1) 0%, rgba(16, 185, 129, 0.1) 100%);
            border: 2px solid var(--border-medium);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .voice-recommendations h3 {
            margin: 0 0 1rem;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            color: var(--text-primary);
        }

        .recommended-voices {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 0.75rem;
        }

        /* Available Voices List */
        .available-voices {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 1rem;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .voice-option {
            padding: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .voice-option:hover {
            background: var(--bg-card);
        }

        .voice-option.selected {
            background: var(--gradient-primary);
            color: white;
        }

        /* Slider Controls */
        .slider-control {
            margin-top: 1rem;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-secondary);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-blue);
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 0.5rem;
        }

        .pitch-value {
            text-align: center;
            font-family: monospace;
            font-weight: bold;
            color: var(--primary-blue);
            margin-top: 0.5rem;
        }

        /* Refresh Button */
        .refresh-btn {
            width: 100%;
            padding: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .refresh-btn:hover {
            background: var(--border-medium);
        }

        /* Output Section */
        .output-content {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            padding: 1.5rem;
            border-radius: 12px;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-subtle);
        }

        /* Responsive Design */
        @media (max-width: 1024px) {
            .nav-sidebar {
                transform: translateX(-100%);
            }

            .controls-panel {
                transform: translateX(100%);
            }

            .main-wrapper {
                margin-left: 0;
                margin-right: 0;
            }

            .mobile-nav {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: var(--bg-card);
                border-top: 1px solid var(--border-subtle);
                display: flex;
                justify-content: space-around;
                padding: 1rem;
                z-index: 100;
            }

            .mobile-nav-item {
                display: flex;
                flex-direction: column;
                align-items: center;
                gap: 0.25rem;
                color: var(--text-muted);
                cursor: pointer;
                font-size: 0.75rem;
            }

            .mobile-nav-item.active {
                color: var(--primary-blue);
            }

            .workspace {
                padding-bottom: 5rem;
            }
        }

        /* Utility Classes */
        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        .loading-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-top: 2px solid currentColor;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: 12px;
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow-medium);
            z-index: 1000;
            opacity: 0;
            transition: all 0.3s ease;
            max-width: calc(100vw - 40px);
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            border-color: var(--primary-green);
            background: rgba(16, 185, 129, 0.1);
            color: var(--primary-green);
        }

        .toast.error {
            border-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }
    </style>
</head>
<body>
    <!-- Auth Container (Shows before login) -->
    <div id="auth-container">
        <div class="auth-background">
            <div class="auth-blob-1"></div>
            <div class="auth-blob-2"></div>
        </div>
        
        <button class="theme-toggle-auth" id="auth-theme-toggle">
            <i class="fas fa-moon" id="auth-theme-icon"></i>
        </button>
        
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-microphone-alt"></i>
                <span>Lumen Voice Studio</span>
            </div>
            
            <h2 class="auth-title">Welcome</h2>
            <p class="auth-subtitle">Sign in to access professional AI voice generation and transcription</p>
            
            <!-- Firebase UI Auth Container -->
            <div id="firebaseui-auth-container"></div>
            
            <div class="auth-footer">
                By signing in, you agree to our <a href="#">Terms of Service</a> and <a href="#">Privacy Policy</a>
            </div>
        </div>
    </div>

    <!-- Main App Container (Shows after login) -->
    <div id="app-container">
        <!-- Navigation Sidebar -->
        <nav class="nav-sidebar">
            <div class="nav-logo">L</div>
            
            <div class="nav-item active" title="Create Audio" onclick="switchSection('create-audio')">
                <i class="fas fa-microphone-alt"></i>
            </div>
            
            <div class="nav-item" title="Voice Library" onclick="switchSection('voice-library')">
                <i class="fas fa-microphone"></i>
            </div>
            
            <div class="nav-item" title="Media Import" onclick="switchSection('media-import')">
                <i class="fas fa-cloud-upload-alt"></i>
            </div>
            
            <div class="nav-item" title="History" onclick="switchSection('history')">
                <i class="fas fa-history"></i>
            </div>
            
            <div class="nav-spacer"></div>
            
            <div class="nav-item" title="Settings" onclick="switchSection('settings')">
                <i class="fas fa-cog"></i>
            </div>
            
            <div class="nav-user" title="Profile" onclick="switchSection('profile')">
                U
            </div>
        </nav>

        <!-- Main Content Area -->
        <div class="main-wrapper">
            <!-- Top Bar -->
            <div class="top-bar">
                <h1 id="pageTitle">Create Audio</h1>
                <div class="top-actions">
                    <div class="status-indicator online" id="statusIndicator">
                        <div class="status-dot"></div>
                        <span>Loading...</span>
                    </div>
                    <button class="theme-toggle" onclick="toggleTheme()">
                        <i class="fas fa-moon" id="theme-icon"></i>
                    </button>
                </div>
            </div>

            <!-- Workspace Area -->
            <div class="workspace">
                <!-- Create Audio Section (Text to Speech) -->
                <div id="create-audio-section" class="workspace-section active">
                    <div class="section-header">
                        <h2 class="section-title">Create Audio from Text</h2>
                    </div>
                    <div>
                        <textarea 
                            id="text" 
                            class="text-input" 
                            placeholder="Type or paste your text here. You can enter up to 50,000 characters..."
                            maxlength="50000"
                            oninput="updateCharCounter()"
                        >Welcome to Lumen Voice Studio! This is a demonstration of our advanced text-to-speech technology.</textarea>
                        <div class="char-counter" id="charCounter">0 / 50,000 characters</div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="previewVoice()" id="previewBtn">
                            <i class="fas fa-play"></i>
                            Preview
                        </button>
                        <button class="btn btn-primary" onclick="generateSpeech()" id="generateBtn">
                            <i class="fas fa-magic"></i>
                            <span>Generate Audio</span>
                        </button>
                        <button class="btn btn-secondary" onclick="clearSession()">
                            <i class="fas fa-broom"></i>
                            Clear Session
                        </button>
                    </div>
                    
                    <!-- Audio Player Section -->
                    <div id="audioSection" style="display: none; margin-top: 2rem;">
                        <div class="section-header">
                            <h2 class="section-title">Audio Output</h2>
                        </div>
                        <div class="audio-player">
                            <audio id="player" controls>
                                Your browser doesn't support HTML audio.
                            </audio>
                            <div class="audio-actions">
                                <button class="btn btn-download" onclick="downloadAudio()" id="downloadAudioBtn">
                                    <i class="fas fa-download"></i>
                                    Download Audio
                                </button>
                                <button class="btn btn-transcribe" onclick="transcribeAudio()" id="transcribeAudioBtn">
                                    <i class="fas fa-closed-captioning"></i>
                                    Transcribe Audio
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Output Section -->
                    <div style="margin-top: 2rem;">
                        <div class="section-header">
                            <h2 class="section-title">Output Log</h2>
                        </div>
                        <div class="output-content" id="output">
ðŸš€ Lumen Voice Studio ready. Loading voices...
                        </div>
                    </div>
                </div>

                <!-- Voice Library Section -->
                <div id="voice-library-section" class="workspace-section">
                    <div class="section-header">
                        <h2 class="section-title">Voice Library</h2>
                        <button class="btn btn-secondary" onclick="refreshVoiceLibrary()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="voice-library-grid" id="voiceLibraryGrid">
                        <!-- Voice cards will be populated here -->
                    </div>
                </div>

                <!-- Media Import Section -->
                <div id="media-import-section" class="workspace-section">
                    <div class="section-header">
                        <h2 class="section-title">Media Import</h2>
                    </div>
                    <div class="media-import" onclick="document.getElementById('mediaAudioUpload').click()">
                        <input type="file" id="mediaAudioUpload" accept="audio/*" style="display: none;" onchange="handleMediaUpload(event)">
                        <div class="upload-icon">
                            <i class="fas fa-cloud-upload-alt"></i>
                        </div>
                        <div class="upload-text" id="mediaUploadLabel">
                            Click to upload audio file<br>
                            <small>MP3, WAV, M4A supported (Max 50MB)</small>
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-success" onclick="transcribeMedia()" id="transcribeMediaBtn">
                            <i class="fas fa-closed-captioning"></i>
                            Transcribe Audio
                        </button>
                        <button class="btn btn-secondary" onclick="generateFromAudio()">
                            <i class="fas fa-magic"></i>
                            Generate from Audio
                        </button>
                    </div>
                    <div id="mediaOutput" class="output-content" style="margin-top: 2rem;">
                        Upload an audio file to begin transcription or processing.
                    </div>
                </div>

                <!-- History Section -->
                <div id="history-section" class="workspace-section">
                    <div class="section-header">
                        <h2 class="section-title">History</h2>
                        <button class="btn btn-secondary" onclick="clearHistory()">
                            <i class="fas fa-trash"></i>
                            Clear History
                        </button>
                    </div>
                    <div class="history-list" id="historyList">
                        <!-- History items will be populated here -->
                    </div>
                </div>

                <!-- Settings Section -->
                <div id="settings-section" class="workspace-section">
                    <div class="section-header">
                        <h2 class="section-title">Settings</h2>
                    </div>
                    <div class="settings-group">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Audio Settings</h3>
                        <div class="setting-item">
                            <span>Default Voice</span>
                            <select id="defaultVoice" class="form-control" style="width: auto;">
                                <option value="en-US-AndrewNeural">Andrew (US English)</option>
                                <option value="en-US-AvaNeural">Ava (US English)</option>
                                <option value="en-GB-SoniaNeural">Sonia (UK English)</option>
                            </select>
                        </div>
                        <div class="setting-item">
                            <span>Default Speed</span>
                            <input type="range" id="defaultSpeed" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 150px;">
                            <span id="speedValue">1.0x</span>
                        </div>
                        <div class="setting-item">
                            <span>Auto-play Preview</span>
                            <input type="checkbox" id="autoPlay" checked>
                        </div>
                    </div>
                    <div class="settings-group">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Application Settings</h3>
                        <div class="setting-item">
                            <span>Auto-save History</span>
                            <input type="checkbox" id="autoSaveHistory" checked>
                        </div>
                        <div class="setting-item">
                            <span>Show Toast Notifications</span>
                            <input type="checkbox" id="showToast" checked>
                        </div>
                        <div class="setting-item">
                            <span>Maximum History Items</span>
                            <input type="number" id="maxHistoryItems" value="50" min="10" max="500" style="width: 80px;">
                        </div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="saveSettings()">
                            <i class="fas fa-save"></i>
                            Save Settings
                        </button>
                        <button class="btn btn-secondary" onclick="resetSettings()">
                            <i class="fas fa-undo"></i>
                            Reset to Defaults
                        </button>
                    </div>
                </div>

                <!-- Profile Section -->
                <div id="profile-section" class="workspace-section">
                    <div class="section-header">
                        <h2 class="section-title">Profile</h2>
                    </div>
                    <div class="profile-card">
                        <div class="profile-avatar" id="profileAvatar">U</div>
                        <h3 id="profileName">User Profile</h3>
                        <p id="profileEmail" style="color: var(--text-muted); margin-bottom: 1rem;">user@example.com</p>
                        <div class="action-buttons">
                            <button class="btn btn-primary" onclick="editProfile()">
                                <i class="fas fa-edit"></i>
                                Edit Profile
                            </button>
                            <button class="btn btn-secondary" onclick="logout()">
                                <i class="fas fa-sign-out-alt"></i>
                                Sign Out
                            </button>
                        </div>
                    </div>
                    <div class="settings-group" style="margin-top: 2rem;">
                        <h3 style="margin-bottom: 1rem; color: var(--text-primary);">Usage Statistics</h3>
                        <div class="setting-item">
                            <span>Audio Files Generated</span>
                            <span id="statsGenerated">0</span>
                        </div>
                        <div class="setting-item">
                            <span>Audio Files Transcribed</span>
                            <span id="statsTranscribed">0</span>
                        </div>
                        <div class="setting-item">
                            <span>Total Processing Time</span>
                            <span id="statsProcessingTime">0 mins</span>
                        </div>
                        <div class="setting-item">
                            <span>Account Created</span>
                            <span id="accountCreated">Today</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Controls Panel (Only show for Create Audio section) -->
        <div class="controls-panel" id="controlsPanel">
            <div class="controls-header">
                <div class="controls-tabs">
                    <div class="tab active" onclick="switchTab('settings')">Voice Settings</div>
                    <div class="tab" onclick="switchTab('history')">Recent</div>
                </div>
            </div>
            
            <div class="controls-content" id="settingsTab">
                <!-- Voice Search and Filters -->
                <div class="control-group">
                    <label class="control-label">Voice Search</label>
                    <div class="voice-filters">
                        <input type="text" id="voiceSearch" class="form-control" placeholder="Search voices..." oninput="filterVoices()">
                        <select id="genderSelect" class="form-control" onchange="filterVoices()">
                            <option value="All">All Genders</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                    </div>
                </div>

                <!-- Recommended Voices -->
                <div class="voice-recommendations">
                    <h3>âœ¨ Recommended Voices</h3>
                    <div class="recommended-voices" id="recommendedVoices">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>

                <!-- Language Selection -->
                <div class="control-group">
                    <label class="control-label" for="languageSelect">Language</label>
                    <select id="languageSelect" class="form-control" onchange="filterVoices()">
                        <option>Loading...</option>
                    </select>
                </div>

                <!-- Available Voices -->
                <div class="control-group">
                    <label class="control-label">Available Voices</label>
                    <div class="available-voices" id="availableVoices">
                        <!-- Populated by JavaScript -->
                    </div>
                    <button class="refresh-btn" onclick="loadVoices()">
                        <i class="fas fa-sync-alt"></i>
                        Refresh Voices
                    </button>
                </div>

                <!-- Playback Speed -->
                <div class="control-group">
                    <label class="control-label">Playback Speed</label>
                    <div class="slider-control">
                        <input type="range" id="speed" class="slider" min="0.5" max="2.0" step="0.1" value="1.0">
                        <div class="slider-labels">
                            <span>0.5x</span>
                            <span>1.0x</span>
                            <span>2.0x</span>
                        </div>
                    </div>
                </div>

                <!-- Pitch Adjustment -->
                <div class="control-group">
                    <label class="control-label">
                        Pitch Adjustment
                        <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: normal;">(-20 to +20 Hz)</span>
                    </label>
                    <div class="slider-control">
                        <input 
                            type="range" 
                            id="pitch" 
                            class="slider" 
                            min="-20" 
                            max="20" 
                            step="1" 
                            value="0"
                            oninput="updatePitchValue()"
                        >
                        <div class="slider-labels">
                            <span>Deeper</span>
                            <span>Higher</span>
                        </div>
                        <div class="pitch-value" id="pitchValue">+0 Hz</div>
                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                            ðŸ’¡ Keep between -10 and +10 Hz for most natural results
                        </small>
                    </div>
                </div>
            </div>
            
            <div class="controls-content hidden" id="historyTab">
                <div class="control-group">
                    <label class="control-label">Recent Audio</label>
                    <div id="recentAudioList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Recent audio items will be populated here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Navigation -->
        <div class="mobile-nav">
            <div class="mobile-nav-item active" onclick="switchSection('create-audio')">
                <i class="fas fa-microphone-alt"></i>
                <span>Create</span>
            </div>
            <div class="mobile-nav-item" onclick="switchSection('voice-library')">
                <i class="fas fa-microphone"></i>
                <span>Voices</span>
            </div>
            <div class="mobile-nav-item" onclick="switchSection('media-import')">
                <i class="fas fa-cloud-upload-alt"></i>
                <span>Import</span>
            </div>
            <div class="mobile-nav-item" onclick="switchSection('history')">
                <i class="fas fa-history"></i>
                <span>History</span>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <script>
        // ==================== FIREBASE CONFIGURATION ====================
        const firebaseConfig = {
            apiKey: "AIzaSyAjskmFLh22fAPVpTPRXQ1exNINGOg7-2M",
            authDomain: "lumogen-auth.firebaseapp.com",
            projectId: "lumogen-auth",
            storageBucket: "lumogen-auth.firebasestorage.app",
            messagingSenderId: "7440317744",
            appId: "1:7440317744:web:c9cd20a74b3f6813b21cf5"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        let currentUserToken = null;

        // Setup FirebaseUI
        const ui = new firebaseui.auth.AuthUI(auth);

        const uiConfig = {
            callbacks: {
                signInSuccessWithAuthResult: function(authResult) {
                    // Sync token with backend
                    authResult.user.getIdToken().then(token => {
                        fetch('/api/auth/sync', {
                            method: 'POST',
                            headers: {'X-Auth-Token': token}
                        });
                    });
                    return false; // Don't redirect
                }
            },
            signInOptions: [
                firebase.auth.EmailAuthProvider.PROVIDER_ID,
                firebase.auth.GoogleAuthProvider.PROVIDER_ID
            ],
            signInFlow: 'popup',
            credentialHelper: firebaseui.auth.CredentialHelper.GOOGLE_YOLO,
            tosUrl: '#',
            privacyPolicyUrl: '#'
        };

        // Auth State Listener
        auth.onAuthStateChanged(async (user) => {
            if (user) {
                // User is signed in
                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                currentUserToken = await user.getIdToken();
                console.log("Logged in as:", user.email);
                
                // Initialize the app after login
                initializeApp();
            } else {
                // User is signed out
                document.getElementById('auth-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                currentUserToken = null;
                
                // Start FirebaseUI
                ui.start('#firebaseui-auth-container', uiConfig);
            }
        });

        // Logout Function
        function logout() {
            if (confirm('Are you sure you want to sign out?')) {
                auth.signOut();
                showToast('Signed out successfully', 'success');
            }
        }

        // ==================== ORIGINAL APP LOGIC ====================
        
        const RECOMMENDED_VOICES = [
            { name: 'William', gender: 'Male', short_name: 'en-AU-WilliamNeural' },
            { name: 'Natasha', gender: 'Female', short_name: 'en-AU-NatashaNeural' },
            { name: 'Clara', gender: 'Female', short_name: 'en-CA-ClaraNeural' },
            { name: 'Liam', gender: 'Male', short_name: 'en-CA-LiamNeural' },
            { name: 'Ava', gender: 'Female', short_name: 'en-US-AvaNeural' },
            { name: 'Andrew', gender: 'Male', short_name: 'en-US-AndrewNeural', best: true },
            { name: 'Emma', gender: 'Female', short_name: 'en-US-EmmaNeural' },
            { name: 'Brian', gender: 'Male', short_name: 'en-US-BrianNeural' }
        ];

        let currentAudioUrl = null;
        let currentAudioFilename = null;
        let selectedVoice = null;
        let filteredVoices = [];
        let allVoices = [];
        let uploadedAudioFile = null;
        let currentJobId = null;
        let isLoading = false;
        let currentSection = 'create-audio';
        let userProfile = {
            name: 'User Name',
            email: 'user@example.com',
            avatar: 'U'
        };
        let historyItems = [];
        let settings = {
            defaultVoice: 'en-US-AndrewNeural',
            defaultSpeed: 1.0,
            autoPlay: true,
            autoSaveHistory: true,
            showToast: true,
            maxHistoryItems: 50
        };

        // Section Switching
        function switchSection(section) {
            // Hide all sections
            document.querySelectorAll('.workspace-section').forEach(el => {
                el.classList.remove('active');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // Remove active class from all mobile nav items
            document.querySelectorAll('.mobile-nav-item').forEach(el => {
                el.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(section + '-section').classList.add('active');
            
            // Update active nav item
            const navIndex = {
                'create-audio': 0,
                'voice-library': 1,
                'media-import': 2,
                'history': 3,
                'settings': 4,
                'profile': 5
            };
            
            if (navIndex[section] !== undefined) {
                document.querySelectorAll('.nav-item')[navIndex[section]].classList.add('active');
                document.querySelectorAll('.mobile-nav-item')[navIndex[section]].classList.add('active');
            }
            
            // Update page title
            const titles = {
                'create-audio': 'Create Audio',
                'voice-library': 'Voice Library',
                'media-import': 'Media Import',
                'history': 'History',
                'settings': 'Settings',
                'profile': 'Profile'
            };
            
            document.getElementById('pageTitle').textContent = titles[section] || 'Lumen Voice Studio';
            
            // Show/hide controls panel
            const controlsPanel = document.getElementById('controlsPanel');
            if (section === 'create-audio') {
                controlsPanel.style.display = 'flex';
            } else {
                controlsPanel.style.display = 'none';
            }
            
            // Load section-specific data
            currentSection = section;
            
            switch(section) {
                case 'voice-library':
                    loadVoiceLibrary();
                    break;
                case 'history':
                    loadHistory();
                    break;
                case 'settings':
                    loadSettings();
                    break;
                case 'profile':
                    loadProfile();
                    break;
            }
            
            showToast(`Switched to ${titles[section] || section}`);
        }

        // Theme Management
        function toggleTheme() {
            const html = document.documentElement;
            const themeIcon = document.getElementById('theme-icon');
            const authThemeIcon = document.getElementById('auth-theme-icon');
            
            if (html.getAttribute('data-theme') === 'dark') {
                html.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-sun';
                if (authThemeIcon) authThemeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            } else {
                html.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-moon';
                if (authThemeIcon) authThemeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            }
        }

        function initTheme() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const themeIcon = document.getElementById('theme-icon');
            const authThemeIcon = document.getElementById('auth-theme-icon');
            
            if (saved === 'dark' || (!saved && prefersDark)) {
                document.documentElement.setAttribute('data-theme', 'dark');
                if (themeIcon) themeIcon.className = 'fas fa-moon';
                if (authThemeIcon) authThemeIcon.className = 'fas fa-moon';
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                if (themeIcon) themeIcon.className = 'fas fa-sun';
                if (authThemeIcon) authThemeIcon.className = 'fas fa-sun';
            }
        }

        // Character counter
        function updateCharCounter() {
            const text = document.getElementById('text').value;
            const counter = document.getElementById('charCounter');
            const length = text.length;
            
            counter.textContent = length.toLocaleString() + ' / 50,000 characters';
            
            if (length > 45000) {
                counter.style.color = '#ef4444';
            } else if (length > 30000) {
                counter.style.color = '#f97316';
            } else {
                counter.style.color = 'var(--text-muted)';
            }
        }

        // Update pitch value display
        function updatePitchValue() {
            const pitch = document.getElementById('pitch').value;
            const pitchDisplay = document.getElementById('pitchValue');
            pitchDisplay.textContent = (pitch > 0 ? '+' : '') + pitch + ' Hz';
        }

        // Toast Notifications
        function showToast(message, type = 'info') {
            if (!settings.showToast && type !== 'error') return;
            
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // Loading States
        function setLoading(loading) {
            isLoading = loading;
            document.body.classList.toggle('loading', loading);
        }

        function setButtonLoading(button, loading) {
            if (loading) {
                const originalText = button.innerHTML;
                button.setAttribute('data-original-text', originalText);
                button.disabled = true;
                button.innerHTML = '<div class="loading-spinner"></div>Processing...';
            } else {
                const originalText = button.getAttribute('data-original-text');
                button.disabled = false;
                button.innerHTML = originalText;
            }
        }

        // Output Management
        function updateOutput(message, type = 'info') {
            const output = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? 'â›”' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            output.textContent = '[' + timestamp + '] ' + prefix + ' ' + message;
            
            if (type === 'error' || type === 'success') {
                showToast(message, type);
            }
        }

        function createVoiceChip(voice) {
            const chip = document.createElement('div');
            chip.className = 'voice-chip' + (voice.best ? ' best' : '');
            chip.innerHTML = '<div class="voice-name">' + voice.name + '</div><div class="voice-gender">' + voice.gender + '</div>';
            
            chip.addEventListener('click', () => {
                // Clear previous selection
                document.querySelectorAll('.voice-chip').forEach(c => c.classList.remove('selected'));
                chip.classList.add('selected');
                
                selectedVoice = voice;
                
                // Also update the voice option in available voices list
                const voiceOptions = document.querySelectorAll('.voice-option');
                voiceOptions.forEach(option => {
                    option.classList.remove('selected');
                    if (option.dataset.shortName === voice.short_name) {
                        option.classList.add('selected');
                    }
                });
                
                updateOutput('Selected voice: ' + voice.name + ' (' + voice.gender + ')', 'success');
            });
            
            return chip;
        }

        function populateRecommendedVoices() {
            const container = document.getElementById('recommendedVoices');
            container.innerHTML = '';
            RECOMMENDED_VOICES.forEach(voice => {
                container.appendChild(createVoiceChip(voice));
            });
        }

        // Show audio actions
        function showAudioActions() {
            document.getElementById('audioSection').style.display = 'block';
        }

        // Hide audio actions
        function hideAudioActions() {
            document.getElementById('audioSection').style.display = 'none';
        }

        // Load voices from API
        async function loadVoices() {
            setLoading(true);
            updateOutput('Loading voice database...');
            
            try {
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                const response = await fetch('/api/voices', { headers });
                const data = await response.json();
                
                const languageSelect = document.getElementById('languageSelect');
                const statusIndicator = document.getElementById('statusIndicator');
                
                const statusClass = data.offline_mode ? 'offline' : 'online';
                const statusText = data.offline_mode ? 'Offline - Limited Voices' : 'Online - ' + data.total_voices + ' Voices';
                statusIndicator.className = 'status-indicator ' + statusClass;
                statusIndicator.querySelector('span').textContent = statusText;
                
                languageSelect.innerHTML = '<option value="All">All Languages</option>';
                const languages = data.languages || [];
                languages.sort().forEach(lang => {
                    const option = document.createElement('option');
                    option.value = lang;
                    option.textContent = lang;
                    languageSelect.appendChild(option);
                });
                
                if (languages.includes('English')) {
                    languageSelect.value = 'English';
                }
                
                updateOutput('Loaded ' + data.total_voices + ' voices', 'success');
                await filterVoices();
                
            } catch (error) {
                updateOutput('Failed to load voices: ' + error.message, 'error');
                // Still populate recommended voices even if API fails
                populateRecommendedVoices();
            } finally {
                setLoading(false);
            }
        }

        // Filter voices
        async function filterVoices() {
            const query = document.getElementById('voiceSearch').value.trim();
            const gender = document.getElementById('genderSelect').value;
            const language = query ? 'All' : document.getElementById('languageSelect').value;

            try {
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                const url = '/api/filter_voices?language=' + encodeURIComponent(language) + '&search=' + encodeURIComponent(query) + '&gender=' + encodeURIComponent(gender);
                const response = await fetch(url, { headers });
                const data = await response.json();

                const container = document.getElementById('availableVoices');
                container.innerHTML = '';

                if (data.voices && data.voices.length > 0) {
                    filteredVoices = data.voices;
                    
                    data.voices.forEach(voice => {
                        const option = document.createElement('div');
                        option.className = 'voice-option';
                        option.textContent = voice.display_name || voice.name;
                        option.dataset.shortName = voice.short_name;
                        
                        option.addEventListener('click', () => {
                            // Clear previous selection
                            document.querySelectorAll('.voice-option').forEach(o => o.classList.remove('selected'));
                            option.classList.add('selected');
                            
                            // Also update voice chips
                            document.querySelectorAll('.voice-chip').forEach(c => c.classList.remove('selected'));
                            
                            selectedVoice = voice;
                            updateOutput('Selected voice: ' + (voice.display_name || voice.name), 'success');
                        });
                        
                        container.appendChild(option);
                    });
                    
                    updateOutput('Found ' + data.voices.length + ' voices');
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 1rem;">No voices found</div>';
                    updateOutput('No voices found', 'error');
                }

            } catch (error) {
                updateOutput('Filter failed: ' + error.message, 'error');
            }
        }

        // Load Voice Library Section
        async function loadVoiceLibrary() {
            try {
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                const response = await fetch('/api/voices', { headers });
                const data = await response.json();
                
                const container = document.getElementById('voiceLibraryGrid');
                container.innerHTML = '';
                
                if (data.voices && Object.keys(data.voices).length > 0) {
                    Object.entries(data.voices).forEach(([language, voices]) => {
                        voices.forEach(voice => {
                            const card = document.createElement('div');
                            card.className = 'voice-library-card';
                            card.innerHTML = `
                                <h4>${voice.display_name || voice.name}</h4>
                                <p style="color: var(--text-muted); font-size: 0.875rem;">${language} â€¢ ${voice.gender}</p>
                                <p style="font-size: 0.75rem; margin-top: 0.5rem;">${voice.short_name}</p>
                                <button class="btn btn-secondary" style="margin-top: 0.5rem;" onclick="selectVoiceFromLibrary('${voice.short_name}')">
                                    <i class="fas fa-check"></i> Select
                                </button>
                            `;
                            container.appendChild(card);
                        });
                    });
                } else {
                    container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No voices available</div>';
                }
            } catch (error) {
                showToast('Failed to load voice library', 'error');
            }
        }

        function selectVoiceFromLibrary(voiceShortName) {
            // Switch to create audio section
            switchSection('create-audio');
            
            // Find and select the voice
            const voiceOption = document.querySelector(`.voice-option[data-short-name="${voiceShortName}"]`);
            if (voiceOption) {
                voiceOption.click();
                showToast('Voice selected successfully', 'success');
            }
        }

        function refreshVoiceLibrary() {
            loadVoiceLibrary();
            showToast('Voice library refreshed', 'success');
        }

        // Media Import Section Functions
        function handleMediaUpload(event) {
            const file = event.target.files[0];
            if (file) {
                if (file.size > 50 * 1024 * 1024) { // 50MB limit
                    showToast('File too large. Maximum size is 50MB.', 'error');
                    return;
                }
                
                uploadedAudioFile = file;
                const uploadLabel = document.getElementById('mediaUploadLabel');
                uploadLabel.innerHTML = '<strong>' + file.name + '</strong><br><small>' + (file.size / 1024 / 1024).toFixed(1) + ' MB</small>';
                document.querySelector('.media-import').classList.add('has-file');
                document.getElementById('mediaOutput').textContent = `File ready: ${file.name}`;
            }
        }

        async function transcribeMedia() {
            if (!uploadedAudioFile) {
                showToast('Please upload an audio file first', 'error');
                return;
            }
            
            const transcribeMediaBtn = document.getElementById('transcribeMediaBtn');
            setButtonLoading(transcribeMediaBtn, true);
            setLoading(true);
            
            const output = document.getElementById('mediaOutput');
            output.textContent = 'Transcribing audio...';
            
            try {
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                const formData = new FormData();
                formData.append('audio', uploadedAudioFile);
                formData.append('model', 'small');
                formData.append('device', 'cpu');
                
                const response = await fetch('/api/transcribe_upload', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.error) {
                    output.textContent = 'Error: ' + data.error;
                    return;
                }
                
                const transcript = data.transcript || data.full_text || 'Transcription completed';
                output.textContent = 'Transcription completed:\n\n' + transcript;
                
                // Add to history
                addToHistory({
                    type: 'transcription',
                    filename: uploadedAudioFile.name,
                    timestamp: new Date().toISOString(),
                    result: transcript.substring(0, 100) + '...'
                });
                
                showToast('Transcription completed', 'success');
                
            } catch (error) {
                output.textContent = 'Transcription failed: ' + error.message;
                showToast('Transcription failed', 'error');
            } finally {
                setButtonLoading(transcribeMediaBtn, false);
                setLoading(false);
            }
        }

        function generateFromAudio() {
            showToast('Audio generation from audio file coming soon', 'info');
        }

        // History Section Functions
        function loadHistory() {
            // Load from localStorage or API
            const savedHistory = localStorage.getItem('lumenHistory');
            if (savedHistory) {
                historyItems = JSON.parse(savedHistory);
            }
            
            const container = document.getElementById('historyList');
            container.innerHTML = '';
            
            if (historyItems.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-muted); padding: 2rem;">No history yet</div>';
                return;
            }
            
            historyItems.reverse().forEach((item, index) => {
                const historyItem = document.createElement('div');
                historyItem.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const timeString = date.toLocaleTimeString();
                const dateString = date.toLocaleDateString();
                
                historyItem.innerHTML = `
                    <div class="history-info">
                        <strong>${item.type === 'generation' ? 'ðŸŽ™ï¸ Audio Generated' : 'ðŸ“ Audio Transcribed'}</strong>
                        <div style="font-size: 0.875rem; color: var(--text-muted);">${item.filename}</div>
                        <div style="font-size: 0.75rem; color: var(--text-muted);">${dateString} ${timeString}</div>
                    </div>
                    <div class="history-actions">
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="viewHistoryItem(${historyItems.length - 1 - index})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" onclick="deleteHistoryItem(${historyItems.length - 1 - index})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                container.appendChild(historyItem);
            });
        }

        function addToHistory(item) {
            if (!settings.autoSaveHistory) return;
            
            historyItems.push(item);
            
            // Limit history size
            if (historyItems.length > settings.maxHistoryItems) {
                historyItems = historyItems.slice(-settings.maxHistoryItems);
            }
            
            // Save to localStorage
            localStorage.setItem('lumenHistory', JSON.stringify(historyItems));
            
            // Refresh history display if we're on the history page
            if (currentSection === 'history') {
                loadHistory();
            }
        }

        function viewHistoryItem(index) {
            const item = historyItems[index];
            alert(`History Item:\n\nType: ${item.type}\nFile: ${item.filename}\nTime: ${new Date(item.timestamp).toLocaleString()}\n\n${item.result || 'No details available'}`);
        }

        function deleteHistoryItem(index) {
            if (confirm('Delete this history item?')) {
                historyItems.splice(index, 1);
                localStorage.setItem('lumenHistory', JSON.stringify(historyItems));
                loadHistory();
                showToast('History item deleted', 'success');
            }
        }

        function clearHistory() {
            if (confirm('Clear all history? This cannot be undone.')) {
                historyItems = [];
                localStorage.removeItem('lumenHistory');
                loadHistory();
                showToast('History cleared', 'success');
            }
        }

        // Settings Section Functions
        function loadSettings() {
            const savedSettings = localStorage.getItem('lumenSettings');
            if (savedSettings) {
                settings = JSON.parse(savedSettings);
            }
            
            document.getElementById('defaultVoice').value = settings.defaultVoice;
            document.getElementById('defaultSpeed').value = settings.defaultSpeed;
            document.getElementById('speedValue').textContent = settings.defaultSpeed + 'x';
            document.getElementById('autoPlay').checked = settings.autoPlay;
            document.getElementById('autoSaveHistory').checked = settings.autoSaveHistory;
            document.getElementById('showToast').checked = settings.showToast;
            document.getElementById('maxHistoryItems').value = settings.maxHistoryItems;
            
            // Add event listener for speed slider
            document.getElementById('defaultSpeed').addEventListener('input', function() {
                document.getElementById('speedValue').textContent = this.value + 'x';
            });
        }

        function saveSettings() {
            settings.defaultVoice = document.getElementById('defaultVoice').value;
            settings.defaultSpeed = parseFloat(document.getElementById('defaultSpeed').value);
            settings.autoPlay = document.getElementById('autoPlay').checked;
            settings.autoSaveHistory = document.getElementById('autoSaveHistory').checked;
            settings.showToast = document.getElementById('showToast').checked;
            settings.maxHistoryItems = parseInt(document.getElementById('maxHistoryItems').value);
            
            localStorage.setItem('lumenSettings', JSON.stringify(settings));
            showToast('Settings saved successfully', 'success');
        }

        function resetSettings() {
            if (confirm('Reset all settings to defaults?')) {
                settings = {
                    defaultVoice: 'en-US-AndrewNeural',
                    defaultSpeed: 1.0,
                    autoPlay: true,
                    autoSaveHistory: true,
                    showToast: true,
                    maxHistoryItems: 50
                };
                
                localStorage.setItem('lumenSettings', JSON.stringify(settings));
                loadSettings();
                showToast('Settings reset to defaults', 'success');
            }
        }

        // Profile Section Functions
        function loadProfile() {
            // Load from localStorage or API
            const savedProfile = localStorage.getItem('lumenProfile');
            if (savedProfile) {
                userProfile = JSON.parse(savedProfile);
            }
            
            // Load stats
            const savedStats = localStorage.getItem('lumenStats') || '{"generated": 0, "transcribed": 0, "processingTime": 0}';
            const stats = JSON.parse(savedStats);
            
            document.getElementById('profileName').textContent = userProfile.name;
            document.getElementById('profileEmail').textContent = userProfile.email;
            document.getElementById('profileAvatar').textContent = userProfile.avatar;
            document.getElementById('statsGenerated').textContent = stats.generated;
            document.getElementById('statsTranscribed').textContent = stats.transcribed;
            document.getElementById('statsProcessingTime').textContent = stats.processingTime + ' mins';
            document.getElementById('accountCreated').textContent = 'Today'; // This would come from backend
        }

        function editProfile() {
            const newName = prompt('Enter your name:', userProfile.name);
            if (newName && newName.trim()) {
                userProfile.name = newName.trim();
                userProfile.avatar = newName.trim().charAt(0).toUpperCase();
                localStorage.setItem('lumenProfile', JSON.stringify(userProfile));
                loadProfile();
                showToast('Profile updated', 'success');
            }
        }

        // Preview voice
        async function previewVoice() {
            const text = document.getElementById('text').value.trim();
            
            if (!text) {
                showToast('Please enter text to preview', 'error');
                return;
            }
            
            if (!selectedVoice) {
                showToast('Please select a voice', 'error');
                return;
            }
            
            const previewBtn = document.getElementById('previewBtn');
            setButtonLoading(previewBtn, true);
            updateOutput('Generating preview...');
            
            try {
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                const speed = parseFloat(document.getElementById('speed').value || '1.0');
                const pitch = document.getElementById('pitch').value || '0';
                
                const response = await fetch('/api/preview', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...headers
                    },
                    body: JSON.stringify({
                        voice: selectedVoice.short_name,
                        speed: speed,
                        pitch: pitch,
                        text: text.substring(0, 200)
                    })
                });
                
                const data = await response.json();
                
                if (data.error) {
                    updateOutput('Preview failed: ' + data.error, 'error');
                    return;
                }
                
                const player = document.getElementById('player');
                player.src = data.audio_url;
                currentAudioUrl = data.audio_url;
                currentAudioFilename = 'preview.mp3';
                
                if (settings.autoPlay) {
                    try {
                        await player.play();
                        updateOutput('Preview playing', 'success');
                    } catch {
                        updateOutput('Preview ready (click play)', 'success');
                    }
                } else {
                    updateOutput('Preview ready (click play)', 'success');
                }
                
                showAudioActions();
                
            } catch (error) {
                updateOutput('Preview failed: ' + error.message, 'error');
            } finally {
                setButtonLoading(previewBtn, false);
            }
        }

        // Generate speech with job polling
        async function generateSpeech() {
            const text = document.getElementById('text').value.trim();
            
            if (!text) {
                showToast('Please enter text', 'error');
                return;
            }
            
            if (!selectedVoice) {
                showToast('Please select a voice', 'error');
                return;
            }
            
            const generateBtn = document.getElementById('generateBtn');
            const speed = parseFloat(document.getElementById('speed').value || '1.0');
            const pitch = document.getElementById('pitch').value || '0';
            const charCount = text.length;
            const estimatedMinutes = Math.ceil(charCount / 1000);
            
            generateBtn.innerHTML = '<div class="loading-spinner"></div>Submitting...';
            generateBtn.disabled = true;
            
            const startTime = Date.now();
            updateOutput('ðŸ“¤ Submitting ' + charCount.toLocaleString() + ' chars (est. ' + estimatedMinutes + ' min)...');
            
            try {
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                const response = await fetch('/api/generate', {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        ...headers
                    },
                    body: JSON.stringify({
                        voice: selectedVoice.short_name,
                        speed: speed,
                        pitch: pitch,
                        text: text
                    })
                });
                
                if (!response.ok) {
                    let errorMsg;
                    try {
                        const data = await response.json();
                        errorMsg = data.error || 'Unknown error';
                    } catch (e) {
                        errorMsg = 'Server error (' + response.status + ')';
                    }
                    throw new Error(errorMsg);
                }
                
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }
                
                const jobId = data.job_id;
                updateOutput('â³ Processing (ID: ' + jobId.substring(0, 8) + '...)...');
                
                await pollJobStatus(jobId, startTime, generateBtn);
                
                // Add to history
                addToHistory({
                    type: 'generation',
                    filename: 'generated_audio.mp3',
                    timestamp: new Date().toISOString(),
                    result: 'Generated audio from text (' + charCount + ' chars)'
                });
                
                // Update stats
                const stats = JSON.parse(localStorage.getItem('lumenStats') || '{"generated": 0, "transcribed": 0, "processingTime": 0}');
                stats.generated += 1;
                stats.processingTime += Math.ceil((Date.now() - startTime) / 60000); // minutes
                localStorage.setItem('lumenStats', JSON.stringify(stats));
                
            } catch (error) {
                updateOutput('âŒ ' + error.message, 'error');
                generateBtn.innerHTML = '<i class="fas fa-magic"></i><span>Generate Audio</span>';
                generateBtn.disabled = false;
            }
        }

        // Poll job status
        async function pollJobStatus(jobId, startTime, generateBtn) {
            let pollInterval = 500; // âœ… Faster polling - 500ms instead of 2000ms
            const maxInterval = 2000;
            let attempts = 0;
            
            if (!startTime) {
                startTime = Date.now();
            }
            
            if (!generateBtn) {
                generateBtn = document.getElementById('generateBtn');
            }
            
            const poll = async () => {
                attempts++;
                const elapsed = Math.ceil((Date.now() - startTime) / 1000);
                
                try {
                    const response = await fetch('/api/jobs/' + jobId); // âœ… Relative path
                    
                    if (!response.ok) {
                        throw new Error('Polling failed: ' + response.status);
                    }
                    
                    const data = await response.json();
                    
                    if (data.status === 'completed') {
                        const player = document.getElementById('player');
                        player.src = data.audio_url;
                        currentAudioUrl = data.audio_url;
                        currentAudioFilename = data.filename;
                        
                        updateOutput('âœ… Generated in ' + elapsed + 's: ' + data.filename, 'success');
                        
                        generateBtn.innerHTML = '<i class="fas fa-magic"></i><span>Generate Audio</span>';
                        generateBtn.disabled = false;
                        
                        try {
                            await player.play();
                        } catch (e) {}
                        
                        showAudioActions();
                        
                    } else if (data.status === 'failed') {
                        throw new Error(data.error || 'Generation failed');
                    } else {
                        // Still processing - gradually increase interval
                        updateOutput('âš™ï¸ Processing... ' + elapsed + 's elapsed (' + attempts + ' checks)');
                        generateBtn.innerHTML = '<div class="loading-spinner"></div>Processing (' + elapsed + 's)...';
                        
                        // Exponential backoff: 500ms -> 750ms -> 1125ms -> 1687ms -> 2000ms
                        pollInterval = Math.min(pollInterval * 1.5, maxInterval);
                        setTimeout(poll, pollInterval);
                    }
                    
                } catch (error) {
                    updateOutput('âŒ Polling error: ' + error.message, 'error');
                    generateBtn.innerHTML = '<i class="fas fa-magic"></i><span>Generate Audio</span>';
                    generateBtn.disabled = false;
                }
            };
            
            poll();
        }

        // Download audio
        async function downloadAudio() {
            if (!currentAudioUrl) {
                showToast('No audio available to download', 'error');
                return;
            }
            
            try {
                const response = await fetch(currentAudioUrl);
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = currentAudioFilename || 'audio.mp3';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                updateOutput('Downloaded: ' + currentAudioFilename, 'success');
            } catch (error) {
                updateOutput('Download failed: ' + error.message, 'error');
            }
        }

        // Transcribe audio
        async function transcribeAudio() {
            if (!currentAudioUrl) {
                showToast('No audio available to transcribe', 'error');
                return;
            }
            
            const transcribeAudioBtn = document.getElementById('transcribeAudioBtn');
            setButtonLoading(transcribeAudioBtn, true);
            updateOutput('Transcribing audio...');
            
            try {
                const response = await fetch(currentAudioUrl);
                const blob = await response.blob();
                
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                const formData = new FormData();
                formData.append('audio', blob, currentAudioFilename);
                formData.append('model', 'small');
                formData.append('device', 'cpu');
                
                const transcribeResponse = await fetch('/api/transcribe_generated', {
                    method: 'POST',
                    headers: headers,
                    body: formData
                });
                
                const data = await transcribeResponse.json();
                
                if (data.error) {
                    updateOutput('Transcription failed: ' + data.error, 'error');
                    return;
                }
                
                const transcript = data.transcript || data.full_text || 'Transcription completed';
                
                const txtBlob = new Blob([transcript], { type: 'text/plain' });
                const txtUrl = window.URL.createObjectURL(txtBlob);
                const a = document.createElement('a');
                a.href = txtUrl;
                a.download = 'transcript_' + Date.now() + '.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(txtUrl);
                
                updateOutput('Transcription completed and saved as txt file:\n\n' + transcript, 'success');
                
                // Add to history
                addToHistory({
                    type: 'transcription',
                    filename: currentAudioFilename,
                    timestamp: new Date().toISOString(),
                    result: 'Transcribed audio file'
                });
                
                // Update stats
                const stats = JSON.parse(localStorage.getItem('lumenStats') || '{"generated": 0, "transcribed": 0, "processingTime": 0}');
                stats.transcribed += 1;
                localStorage.setItem('lumenStats', JSON.stringify(stats));
                
            } catch (error) {
                updateOutput('Transcription failed: ' + error.message, 'error');
            } finally {
                setButtonLoading(transcribeAudioBtn, false);
            }
        }

        // Clear session
        async function clearSession() {
            setLoading(true);
            updateOutput('Cleaning up...');
            
            try {
                const headers = {};
                if (currentUserToken) headers['X-Auth-Token'] = currentUserToken;

                await fetch('/api/cleanup', { 
                    method: 'POST',
                    headers: headers
                });
                
                document.getElementById('text').value = '';
                document.getElementById('player').src = '';
                currentAudioUrl = null;
                currentAudioFilename = null;
                uploadedAudioFile = null;
                currentJobId = null;
                
                const uploadLabel = document.getElementById('uploadLabel');
                uploadLabel.innerHTML = 'Click to upload or drag and drop<br><small>MP3, WAV, M4A supported</small>';
                document.querySelector('.media-import').classList.remove('has-file');
                
                hideAudioActions();
                updateCharCounter();
                updateOutput('Session cleaned up', 'success');
                
            } catch (error) {
                updateOutput('Cleanup failed: ' + error.message, 'error');
            } finally {
                setLoading(false);
            }
        }

        // Switch tabs in controls panel
        function switchTab(tab) {
            const tabs = document.querySelectorAll('.tab');
            const settingsTab = document.getElementById('settingsTab');
            const historyTab = document.getElementById('historyTab');
            
            tabs.forEach(t => t.classList.remove('active'));
            
            if (tab === 'settings') {
                tabs[0].classList.add('active');
                settingsTab.classList.remove('hidden');
                historyTab.classList.add('hidden');
            } else {
                tabs[1].classList.add('active');
                settingsTab.classList.add('hidden');
                historyTab.classList.remove('hidden');
            }
        }

        // Initialize app
        function initializeApp() {
            initTheme();
            updateCharCounter();
            updatePitchValue();
            populateRecommendedVoices();
            loadVoices();
            loadSettings();
            loadProfile();
            
            // Set default voice selection (Andrew as best)
            setTimeout(() => {
                selectedVoice = RECOMMENDED_VOICES.find(v => v.best) || RECOMMENDED_VOICES[0];
                if (selectedVoice) {
                    const voiceChips = document.querySelectorAll('.voice-chip');
                    voiceChips.forEach(chip => {
                        const name = chip.querySelector('.voice-name').textContent;
                        if (name === selectedVoice.name) {
                            chip.classList.add('selected');
                        }
                    });
                    updateOutput('Default voice selected: ' + selectedVoice.name + ' (' + selectedVoice.gender + ')', 'success');
                }
            }, 500);
            
            // Initialize stats if not exists
            if (!localStorage.getItem('lumenStats')) {
                localStorage.setItem('lumenStats', JSON.stringify({
                    generated: 0,
                    transcribed: 0,
                    processingTime: 0
                }));
            }
        }

        // Initialize theme on page load
        window.addEventListener('load', () => {
            initTheme();
        });
    </script>
</body>
</html>
